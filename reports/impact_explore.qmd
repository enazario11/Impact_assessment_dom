---
title: "Whale Safe Impact"
author: "Emily Nazario"
date: "`r Sys.Date()`"
format:
 html: 
  self-contained: true
editor: visual
toc: TRUE
toc-title: "On this page"
theme: yeti
fontcolor: "#134f5c"
editor_options: 
  chunk_output_type: console
---

```{r}
#| warning: false
#| include: false
#| echo: false
#| label: libraries and data

library(tidyverse)
library(here)
library(tidyquant)
library(patchwork)
library(kableExtra) #table
library(webr) #donut plot
library(MetBrewer)
library(ggridges)

wpr_join <- readRDS(here(file = "data/wpr_join.rds"))

ms_theme <- function(){
  theme_tq() %+replace%
            theme(axis.title = element_text(size = 16), 
                  axis.text = element_text(size = 12, color = "black"), 
                  strip.text = element_text(size = 16, color = "white"), 
                  legend.title = element_text(size = 16), 
                  legend.text = element_text(size = 14))
}

# whale presence rating (wpr) data
sf_wpr <- read.csv(here("data/wpr/sf_whale_data.csv"))
socal_wpr <- read.csv(here("data/wpr/socal_whale_data.csv"))

sf_wpr2 <- read.csv(here("data/wpr/sf_whale_data_updated_acoustics.csv"))
socal_wpr2 <- read.csv(here("data/wpr/socal_whale_data_updated_acoustics.csv"))

wpr <- rbind(sf_wpr, socal_wpr)
wpr <- wpr %>%
  mutate(date_pt = as.Date(date_pt, format = "%m/%d/%Y"), 
         year = year(date_pt), 
         mo = month(date_pt),
         yr_mo = zoo::as.yearmon(date_pt))

#vessel speed reduction (vsr) data
mb_vsr <- read.csv(here("data/vsr/monterey_vsr.csv")) 
sf_vsr <- read.csv(here("data/vsr/sf_vsr.csv")) %>% mutate(cooperation = cooperation/100)
socal_vsr <- read.csv(here("data/vsr/socal_vsr.csv")) %>% mutate(cooperation = cooperation/100)

vsr <- rbind(mb_vsr, sf_vsr, socal_vsr)
vsr <- vsr %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y"), 
         year = year(date), 
         mo = month(date),
         yr_mo = zoo::as.yearmon(date))

```

# Voluntary Vessel Speed Reduction (VSR) Zone & Whale Safe background

## VSR data notes

San Francisco data does not include the Monterey Bay National Marine Sanctuary, which was added to the VSR program in 2023. The Whale Safe system that was launched in San Francisco was designed to give whale presence in the San Francisco portion of the VSR zones so we are reporting on them separately here for now. The Monterey Bay stats come from a different data pipeline and the offseason stats are not tracked as regularly.

### **Whale Safe System Launch Dates**

Southern California: September 17, 2020

San Francisco: September 21, 2022

### **Vessel Speed Reduction Zones**

::: {layout-ncol="2"}
![](images/norcal_vsr-01.jpg){fig-align="center" width="500"}

![](images/socal_vsr.jpg){fig-align="center" width="500"}
:::

### **Vessel Speed Reduction Season Dates:**

Southern California:

-   June 4 - December 31, 2018:

-   May 15 - December 15, 2019

-   May 15 - December 15, 2020

-   May 15 - December 15, 2021

-   May 1 - December 15, 2022

-   May 1 - December 15, 2023

-   May 1 , 2024 - January 15, 2025

San Francisco

-   May 1 - November 15, 2019

-   May 1 - November 15, 2020

-   May 1 - November 15, 2021

-   May 1 - December 15, 2022

-   May 1 - December 15, 2023

-   May 1 , 2024 - January 15, 2025

## WPR data notes

Blue whale model data might have been retroactively filled in after periods where the server was down. We don’t have this tracked in our data so there may be days where the Whale Presence Rating didn’t take the blue whale model value into account.

Each species has a threshold for each data stream see [Methodology](https://whalesafe.com/methodology/) for what is considered low-high (0-1). The Whale Presence Rating considers the highest rating of any of the data streams over 5 days. Two species need to have a *high* rating in order for the overall Whale Presence Rating to be 'Very High'.

# Vessel compliance/cooperation level

## Cooperation time series w.r.t. VSR status

Time series grouped by region where grey shaded bars represent time periods when the VSR zone in each respective region was active. Points represent year-month averages pooled across vessel types for each region.

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 9
#| fig-align: "center"
#| label: compliance time series

#create dataframes for dates VSR was active
vsr_dates <- data.frame(
  zone = c(rep("Socal VSR", 7), rep("SF VSR", 6), rep("Monterey Bay VSR", 2)),
  start = c("06/04/2018", "05/15/2019", "05/15/2020", "05/15/2021", "05/01/2022", "05/01/2023", "05/01/2024", "05/01/2019", "05/01/2020", "05/01/2021", "05/01/2022","05/01/2023", "05/01/2024", "05/01/2023", "05/01/2024"), 
  end = c("12/31/2018", "12/15/2019", "12/15/2020", "12/15/2021", "12/15/2022", "12/15/2023", "01/15/2025", "11/15/2019", "11/15/2020", "11/15/2021", "12/15/2022", "12/15/2023", "01/15/2025", "12/15/2023", "01/15/2025"))

vsr_dates <- vsr_dates %>% 
  mutate(start = as.Date(start, format = "%m/%d/%Y"), 
         end = as.Date(end, format = "%m/%d/%Y"),
         yr_mo_s = zoo::as.yearmon(start), 
         yr_mo_e = zoo::as.yearmon(end))

vsr <- vsr %>% mutate(yr_wk = strftime(date, format = "%Y-%W"), 
                      join_id = paste0(zone, "_", yr_wk))
vsr_subset <- vsr %>% subset(select = c(join_id, yr_mo)) %>% distinct(join_id, .keep_all = TRUE)

vsr_dat_ship <- vsr %>%
  mutate(yr_wk = strftime(date, format = "%Y-%W"), 
         join_id = paste0(zone, "_", yr_wk)) %>% 
  group_by(join_id, zone, yr_wk) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
         sd_co = sd(cooperation, na.rm = TRUE))

vsr_dat_ship <- vsr_dat_ship %>% left_join(vsr_subset)

#get vsr active dates
sf_vsr_on <- vsr_dates %>% filter(zone == "SF VSR")
socal_vsr_on <- vsr_dates %>% filter(zone == "Socal VSR")

#sf
sf <- vsr_dat_ship %>% 
  filter(zone == "SF VSR") %>%
ggplot(aes(yr_mo, mean_co)) +
  geom_rect(data = sf_vsr_on, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_path(size = 1.5, alpha = 0.6, color = "#1F2D3D")+
  geom_point(size = 3, color = "#1F2D3D", fill = "#1F2D3D", alpha = 0.8)+
  xlab("")+
  ylab("Weekly cooperation (%)") +
  facet_wrap(~zone)+
  guides(color = "none")+
  ylim(15, 85)+
  ms_theme()

#socal
socal <- vsr_dat_ship %>% 
  filter(zone == "Socal VSR") %>%
ggplot(aes(yr_mo, mean_co)) +
  geom_rect(data = socal_vsr_on, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_path(size = 1.5, alpha = 0.6, color = "#1F2D3D")+
  geom_point(size = 3, color = "#1F2D3D", fill = "#1F2D3D", alpha = 0.8)+
  xlab("")+
  ylab("Weekly cooperation (%)") +
  facet_wrap(~zone)+
  guides(color = "none")+
  ylim(15, 85)+
  ms_theme()

sf/socal

```

## Cooperation table: Zone x Ship category

Table displaying % cooperation grouped by region and ship category. Values in the active and inactive columns represent cooperation by VSR status, and the final column represents the change in cooperation between periods when the VSR is active vs. inactive.

```{r}
#| warning: false
#| echo: false
#| label: average compliance by vsr activity

#provide column with in season, out season, and % change btwn (all years pooled)
vsr_ship_seas <- vsr %>%
  group_by(zone, ship_category, vsr_season) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE)) %>%
  pivot_wider(names_from = "vsr_season", 
              values_from = "mean_co") %>%
  mutate('% change' = inactive-active)

colnames(vsr_ship_seas) <- c("Zone", "Ship category", "VSR active cooperation (%)", "VSR inactive cooperation (%)", "Change (%)")

kbl(vsr_ship_seas[,2:5]) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows("Monterey Bay", 1, 11, label_row_css = "background-color: #134f5c ; color: #fff;") %>%
  pack_rows("San Francisco", 12, 22, label_row_css = "background-color: #134f5c ; color: #fff;") %>%
  pack_rows("Southern California", 23, 33, label_row_css = "background-color: #134f5c ; color: #fff;")

```

## Changes in cooperation by ship category

Monterey Bay is not included in this analysis given that no data on cooperation rates during inactive VSR seasons are available.

```{r}
#| warning: false
#| echo: false
#| fig-width: 12
#| fig-height: 6
#| fig-align: "center"
#| label: average compliance by ship category

vsr %>% 
  filter(zone != "Monterey Bay VSR") %>%
  group_by(zone, ship_category, vsr_season) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            sd_co = sd(cooperation, na.rm = TRUE)) %>%
ggplot(aes(ship_category, mean_co, color = vsr_season)) + 
  geom_errorbar(aes(ymin = mean_co - sd_co, ymax = mean_co + sd_co), size = 1, width = 0, position = position_dodge(width = 0.5))+
  geom_point(size = 3.5, position = position_dodge(width = 0.5))+
  facet_wrap(~zone, scales = "free_x", nrow = 2) + 
  ylab("Cooperation (%)")+
  xlab("")+
  labs(color = "VSR season status")+
  scale_color_manual(values = c("#4682B4", "#E25B32"))+
  ms_theme()+
    theme(legend.position = "top", 
          legend.justification = "left")
  
```

## Changes in cooperation time series

Monterey Bay is not included in this analysis given that no data on cooperation rates during inactive VSR seasons are available.

```{r}
#| warning: false
#| echo: false
#| fig-width: 12
#| fig-height: 9
#| fig-align: "center"
#| label: change in compliance time series

vsr_ship_ts <- vsr %>%
  group_by(year, zone, ship_category, vsr_season) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE)) %>%
  pivot_wider(names_from = "vsr_season", 
              values_from = "mean_co") %>%
  mutate('% change' = inactive-active) %>%
  filter(zone != "Monterey Bay VSR")

ggplot(vsr_ship_ts, aes(year, `% change`, group = zone, color = zone)) +
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Mean change in annual cooperation (%)") +
  labs(color = "Zone") + 
  facet_wrap(~ship_category)+
  scale_color_manual(values = c("#1F2D3D", "#4682B4"))+
  ms_theme()+
  theme(legend.position = "top", 
        legend.justification = "left")


```

# Whale presence rating and vessel compliance

## Whale presence rating and VSR zone activity

Percent of data where the VSR zone was active vs. inactive, and within VSR status groupings, what the whale presence rating was. Monterey Bay is not included in this analysis as there is no whale presence rating data available.

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| label: wpr and vsr activity
#| include: false

#possibly a donut plot showing wpr proportions when vsr is active vs. inactive
source(here("functions/pd_func.R"))

PD <- wpr %>%
  group_by(zone, vsr_season, whale_presence_rating) %>% 
  summarise(n = n()) %>%
  mutate(whale_presence_rating = as.factor(whale_presence_rating))
PD$whale_presence_rating <- fct_relevel(PD$whale_presence_rating, c("Low", "Medium", "High" , "Very High"))
colnames(PD) <- c("Zone", "VSR_status", "Whale_presence_rating", "count")

# separate by region
#PD SF
PD_SF <- PD %>% filter(Zone == "SF VSR")
PD_SF_plot <- PieDonut_c(PD_SF, aes(VSR_status, Whale_presence_rating, count = count), showDonutName = FALSE, showPieName = FALSE)

#PD Socal
PD_SC <- PD %>% filter(Zone == "Socal VSR")
PD_SC_plot <- PieDonut_c(PD_SC, aes(VSR_status, Whale_presence_rating, count = count), showDonutName = FALSE, showPieName = FALSE)

#export size is 586x586
```

![](images/PD_adobe.png)

## Whale presence rating and VSR status timeseries

```{r}
#| warning: false
#| echo: false
#| fig-width: 12
#| fig-height: 8
#| fig-align: "center"
#| label: wpr and vsr status

# wpr_join$wpr_score <- NA
# for(i in 1:nrow(wpr_join)){
#   if(wpr_join$whale_presence_rating[i] == "Low"){
#     wpr_join$wpr_score[i] = 1
#   }
#   if(wpr_join$whale_presence_rating[i] == "Medium"){
#     wpr_join$wpr_score[i] = 2
#   }
#   if(wpr_join$whale_presence_rating[i] == "High"){
#     wpr_join$wpr_score[i] = 3
#   }
#   if(wpr_join$whale_presence_rating[i] == "Very High"){
#     wpr_join$wpr_score[i] = 4
#   }
# }

#saveRDS(wpr_join, here(file = "data/wpr_join.rds"))
wpr_join <- readRDS(here(file = "data/wpr_join.rds"))

#sf
sf_vsr_on2 <- sf_vsr_on[4:6,]

sf_wpr_score <- wpr_join %>% 
  filter(zone == "SF VSR") %>%
  group_by(yr_mo) %>%
  summarise(mean_wpr = mean(wpr_score, na.rm = TRUE)) %>%
  ggplot(aes(x = yr_mo, y = mean_wpr)) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3, color = "#1F2D3D", fill = "#1F2D3D")+
  geom_path(size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  ylab("Year-month WPR") +
  labs(title = "SF VSR") +
  ms_theme()

#socal
socal_vsr_on2 <- socal_vsr_on[3:7,]

socal_wpr_score <- wpr_join %>% 
  filter(zone == "Socal VSR") %>%
  group_by(yr_mo) %>%
  summarise(mean_wpr = mean(wpr_score, na.rm = TRUE)) %>%
  ggplot(aes(x = yr_mo, y = mean_wpr)) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3, color = "#1F2D3D", fill = "#1F2D3D")+
  geom_path(size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  ylab("Year-month WPR") +
  labs(title = "Socal VSR") +
  ms_theme()

sf_wpr_score/socal_wpr_score
```

## Whale presence rating and vessel cooperation

Percent cooperation grouped by VSR status (inactive vs. active) and whale presence rating. Here, we are only plotting cooperation data between 15-85% to remove those who never cooperate, and those who might always "cooperate" due to external factors (i.e., vessel speed capacity).

### San Francisco

```{r}
#| warning: false
#| echo: false
#| fig-width: 12
#| fig-height: 8
#| fig-align: "center"
#| label: SF whale presence rating and vessel speed cooperation

sub_vsr <- vsr %>% 
  mutate(id = paste(date, zone, sep = "_")) %>%
  subset(select = c(id, cooperation))

wpr_join <- wpr %>%
  mutate(id = paste(date_pt, zone, sep = "_"))
wpr_join <- wpr_join %>% inner_join(sub_vsr, by = join_by(id == id)) %>% mutate(whale_present_rating = as.factor(whale_presence_rating))

wpr_join$whale_presence_rating <- fct_relevel(wpr_join$whale_presence_rating, c("Low", "Medium", "High" , "Very High"))

#sf
wpr_join %>%
  filter(zone == "SF VSR") %>%
  ggplot(aes(whale_presence_rating, cooperation, fill = whale_presence_rating)) +
  geom_boxplot(color = "black") +
  facet_wrap(~vsr_season) +
  scale_fill_manual(values = c("#1F2D3D", "#4682B4", "#F6EDD3", "#F29E1F")) +
  xlab("Whale presence rating") +
  ylab("Cooperation (%)") + 
  guides(fill = "none")+
  ms_theme() 

```

### Southern California

```{r}
#| warning: false
#| echo: false
#| fig-width: 12
#| fig-height: 8
#| fig-align: "center"
#| label: SC whale presence rating and vessel speed cooperation

#socail
wpr_join %>%
  filter(zone == "Socal VSR") %>%
  ggplot(aes(whale_presence_rating, cooperation, fill = whale_presence_rating)) +
  geom_boxplot(color = "black") +
  facet_wrap(~vsr_season) +
  scale_fill_manual(values = c("#1F2D3D", "#4682B4", "#F6EDD3", "#F29E1F")) +
  xlab("Whale presence rating") +
  ylab("Cooperation (%)") + 
  guides(fill = "none")+
  ms_theme() 

```

## Whale sightings data and vessel cooperation time series

```{r}
#| warning: false
#| echo: false
#| fig-width: 9
#| fig-height: 8
#| fig-align: "center"
#| label: whale sightings and vessel speed cooperation time series

#sf
sf2 <- vsr %>% 
  group_by(yr_mo, zone) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            sd_co = sd(cooperation, na.rm = TRUE)) %>%
  filter(zone == "SF VSR" & as.Date(yr_mo) >= as.Date(c("2022/07/01"), format = "%Y/%m/%d")) %>%
ggplot(aes(yr_mo, mean_co, color = zone)) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Cooperation (%)") +
  scale_color_manual(values = "#1F2D3D")+
  facet_wrap(~zone)+
  guides(color = "none")+
  ylim(20, 85)+
  ms_theme()

sf_whale <- wpr_join %>% 
  group_by(yr_mo, zone) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            sight_fin = mean(s_fincount, na.rm = TRUE), 
            sight_hump = mean(s_humpbackcount, na.rm = TRUE), 
            sight_blu = mean(s_bluecount, na.rm = TRUE)) %>%
  pivot_longer(cols = sight_fin:sight_blu, 
               names_to = "whale", 
               values_to = "mean_s") %>%
  filter(zone == "SF VSR") %>%
  ggplot(aes(x = yr_mo, y = mean_s, color = whale)) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Sightings") +
  labs(title = "SF VSR") +
  scale_color_manual(values = c("#1F2D3D", "#4682B4", "#F29E1F"))+
  facet_wrap(~whale, scales = "free_y")+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

sf_acou <- wpr_join %>% 
  group_by(yr_mo, zone) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            ac_fin = mean(fn_ac_score, na.rm = TRUE), 
            ac_hump = mean(hm_ac_score, na.rm = TRUE), 
            ac_blu = mean(bw_ac_score, na.rm = TRUE)) %>%
  pivot_longer(cols = ac_fin:ac_blu, 
               names_to = "whale", 
               values_to = "mean_s") %>%
  filter(zone == "SF VSR") %>%
  ggplot(aes(x = yr_mo, y = mean_s, color = whale)) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Acoustic scores") +
  labs(title = "SF VSR") +
  scale_color_manual(values = c("#1F2D3D", "#4682B4", "#F29E1F"))+
  facet_wrap(~whale, scales = "free_y")+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

sf2/sf_whale/sf_acou

#socal
socal2 <- vsr %>% 
  group_by(yr_mo, zone) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            sd_co = sd(cooperation, na.rm = TRUE)) %>%
  filter(zone == "Socal VSR" & as.Date(yr_mo) >= as.Date(c("2020/05/01"), format = "%Y/%m/%d")) %>%
ggplot(aes(yr_mo, mean_co, color = zone)) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Cooperation (%)") +
  scale_color_manual(values = "#1F2D3D")+
  facet_wrap(~zone)+
  guides(color = "none")+
  ylim(20, 85)+
  ms_theme()

socal_whale <- wpr_join %>% 
  group_by(yr_mo, zone) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            sight_fin = mean(s_fincount, na.rm = TRUE), 
            sight_hump = mean(s_humpbackcount, na.rm = TRUE), 
            sight_blu = mean(s_bluecount, na.rm = TRUE)) %>%
  pivot_longer(cols = sight_fin:sight_blu, 
               names_to = "whale", 
               values_to = "mean_s") %>%
  filter(zone == "Socal VSR") %>%
  ggplot(aes(x = yr_mo, y = mean_s, color = whale)) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Sightings") +
  labs(title = "Socal VSR") +
  scale_color_manual(values = c("#1F2D3D", "#4682B4", "#F29E1F"))+
  facet_wrap(~whale, scales = "free_y")+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

socal_acou <- wpr_join %>% 
  group_by(yr_mo, zone) %>%
  summarise(mean_co = mean(cooperation, na.rm = TRUE), 
            ac_fin = mean(fn_ac_score, na.rm = TRUE), 
            ac_hump = mean(hm_ac_score, na.rm = TRUE), 
            ac_blu = mean(bw_ac_score, na.rm = TRUE)) %>%
  pivot_longer(cols = ac_fin:ac_blu, 
               names_to = "whale", 
               values_to = "mean_s") %>%
  filter(zone == "Socal VSR") %>%
  ggplot(aes(x = yr_mo, y = mean_s, color = whale)) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = yr_mo_s, xmax = yr_mo_e), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(size = 3)+
  geom_path(size = 1.5, alpha = 0.8)+
  xlab("")+
  ylab("Acoustic scores") +
  labs(title = "Socal VSR") +
  scale_color_manual(values = c("#1F2D3D", "#4682B4", "#F29E1F"))+
  facet_wrap(~whale, scales = "free_y")+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

socal2/socal_whale/socal_acou

```

## Blue whale data streams time series

Across metrics, data points represent the year-month average for blue whales. Light grey shaded regions represent seasons when the VSR is active, while the striped regions represent when data was unavailable from the respective source.

For the acoustics panels, year-month averages were done by assigning a "Low Rating" a 1, a "Medium Rating" a 2, a "High Rating" a 3, and "offline" an NA. Then, averages were taken of these scores, and the means were plotted as they fit across the ranges of these three bins.

![](images/blue_ts_data-01.png){fig-align="center" width="6000"}

```{r}
#| warning: false
#| label: NA count blue data stream
#| echo: false

sf_zone <- wpr_join %>% filter(zone == "SF VSR") %>% distinct(date_pt, .keep_all = TRUE)
sf_length <- length(unique(sf_zone$date_pt))

socal_zone <- wpr_join %>% filter(zone == "Socal VSR") %>% distinct(date_pt, .keep_all = TRUE)
socal_length <- length(unique(socal_zone$date_pt))

sf_ac_na <- as.data.frame(table(sf_zone$blue_acoustic)) %>%
  mutate(prop_time = Freq/sf_length)
socal_ac_na <- as.data.frame(table(socal_zone$blue_acoustic))%>%
  mutate(prop_time = Freq/socal_length)

sf_ww_na <- as.data.frame(table(sf_zone$bwmv_rating)) %>%
  mutate(prop_time = Freq/sf_length)
socal_ww_na <- as.data.frame(table(socal_zone$bwmv_rating)) %>%
  mutate(prop_time = Freq/socal_length)
```

| Region (n = days)              | System      | Percent days offline |
|--------------------------------|:------------|:---------------------|
| San Francisco (n = 846)        | Acoustics   | 56.03%               |
| Southern California (n = 1579) | Acoustics   | 24.64%               |
| San Francisco (n = 846)        | Whale Watch | 20.09%               |
| Southern California (n = 1579) | Whale Watch | 11.40%               |

: Proportion of days per region data was offline

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| label: blue whale data stream comparison sf

# wpr_join$bw_ac_score <- NA
# wpr_join$hm_ac_score <- NA  
# wpr_join$fn_ac_score <- NA

 #for(i in 1:nrow(wpr_join)){
   #bw scores
   # if(wpr_join$blue_acoustic[i] == "offline"){
   #   wpr_join$bw_ac_score[i] = NA
   # }
   # if(wpr_join$blue_acoustic[i] == "Low Rating"){
   #   wpr_join$bw_ac_score[i] = 1
   # }
   # if(wpr_join$blue_acoustic[i] == "Medium Rating"){
   #   wpr_join$bw_ac_score[i] = 2
   # }
   # if(wpr_join$blue_acoustic[i] == "High Rating"){
   #   wpr_join$bw_ac_score[i] = 3
   # }
    #humpback scores
#    if(wpr_join$humpback_acoustic[i] == "offline"){
#      wpr_join$hm_ac_score[i] = NA
#    }
#    if(wpr_join$humpback_acoustic[i] == "Low Rating"){
#      wpr_join$hm_ac_score[i] = 1
#    }
#    if(wpr_join$humpback_acoustic[i] == "Medium Rating"){
#      wpr_join$hm_ac_score[i] = 2
#    }
#    if(wpr_join$humpback_acoustic[i] == "High Rating"){
#      wpr_join$hm_ac_score[i] = 3
#    }
#    
#    #fin scores
#    if(wpr_join$fin_acoustic[i] == "offline"){
#      wpr_join$fn_ac_score[i] = NA
#    }
#    if(wpr_join$fin_acoustic[i] == "Low Rating"){
#      wpr_join$fn_ac_score[i] = 1
#    }
#    if(wpr_join$fin_acoustic[i] == "Medium Rating"){
#      wpr_join$fn_ac_score[i] = 2
#    }
#    if(wpr_join$fin_acoustic[i] == "High Rating"){
#      wpr_join$fn_ac_score[i] = 3
#   }
# }
# 
# saveRDS(wpr_join, here(file = "data/wpr_join.rds"))



#sf
sf_sight <- wpr %>%
  group_by(yr_mo, zone) %>%
    summarise(sight_blu = mean(s_bluecount, na.rm = TRUE)) %>%
  filter(zone == "SF VSR") %>%
  ggplot(aes(x = as.Date(yr_mo))) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = as.Date(yr_mo_s),   xmax = as.Date(yr_mo_e)), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(aes(y = sight_blu), size = 3, color = "#1F2D3D")+
  geom_path(aes(y = sight_blu), size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  labs(title = "SF VSR")+
  ylab("Sightings (No. whales)") +
  scale_x_date(date_breaks = "5 month",
               date_labels = "%b %Y",
               oob = scales::oob_keep,
               limits = as.Date(c('2022-09-01','2025-01-01'), format = "%Y-%m-%d"))+
  ms_theme()+
  theme(
         panel.background = element_rect(fill='transparent'),
         plot.background = element_rect(fill='transparent', color=NA),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         legend.background = element_rect(fill='transparent'),
         legend.box.background = element_rect(fill='transparent'))

sf_ac <- wpr %>%
  group_by(yr_mo, zone) %>%
  summarise(acou_blu = mean(blue_acoustic_percent, na.rm = TRUE)) %>%
  filter(zone == "SF VSR") %>%
  ggplot(aes(x = as.Date(yr_mo))) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = as.Date(yr_mo_s), xmax = as.Date(yr_mo_e)), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(aes(y = acou_blu), size = 3, color = "#1F2D3D")+
  geom_path(aes(y = acou_blu), size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  scale_y_continuous(name = "Acoustics detection percentage (%)")+
  scale_x_date(date_breaks = "5 month",
                 date_labels = "%b %Y",
                 oob = scales::oob_keep,
                 limits = as.Date(c('2022-09-01','2025-01-01'), format = "%Y-%m-%d"))+
  ms_theme()+
  theme(
         panel.background = element_rect(fill='transparent'),
         plot.background = element_rect(fill='transparent', color=NA),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         legend.background = element_rect(fill='transparent'),
         legend.box.background = element_rect(fill='transparent'))

sf_ww <- wpr %>%
  group_by(yr_mo, zone) %>%
  summarise(ww_blu = mean(bwmv, na.rm = TRUE)) %>%
  filter(zone == "SF VSR") %>%
  ggplot(aes(x = as.Date(yr_mo))) +
  geom_rect(data = sf_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = as.Date(yr_mo_s), xmax = as.Date(yr_mo_e)), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(aes(y = ww_blu), size = 3, color = "#1F2D3D")+
  geom_path(aes(y = ww_blu), size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  ylab("Habitat suitability index") +
  scale_x_date(date_breaks = "5 month",
                 date_labels = "%b %Y",
                 oob = scales::oob_keep,
                 limits = as.Date(c('2022-09-01','2025-01-01'), format = "%Y-%m-%d"))+
  ms_theme()+
  theme(
         panel.background = element_rect(fill='transparent'),
         plot.background = element_rect(fill='transparent', color=NA),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         legend.background = element_rect(fill='transparent'),
         legend.box.background = element_rect(fill='transparent'))

all_sf <- sf_sight/sf_ac/sf_ww
all_sf
# ggsave(here("figs/blue_ts/sf.png"), all_sf, height = 10, width = 9, units = c("in"), bg= 'transparent')
```

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| label: blue whale data stream comparison socal

#socal
socal_sight <- wpr %>%
  group_by(yr_mo, zone) %>%
  summarise(sight_blu = mean(s_bluecount, na.rm = TRUE)) %>%
  filter(zone == "Socal VSR") %>%
  ggplot(aes(x = as.Date(yr_mo))) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = as.Date(yr_mo_s), xmax = as.Date(yr_mo_e)), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(aes(y = sight_blu), size = 3, color = "#1F2D3D")+
  geom_path(aes(y = sight_blu), size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  labs(title = "Socal VSR")+
  ylab("Sightings (No. whales)") +
  scale_x_date(date_breaks = "9 month",
                 date_labels = "%b %Y",
                 oob = scales::oob_keep,
                 limits = as.Date(c('2020-10-01','2025-01-01'), format = "%Y-%m-%d"))+
  ms_theme()+
  theme(
         panel.background = element_rect(fill='transparent', color = NA),
         plot.background = element_rect(fill='transparent', color=NA),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         legend.background = element_blank(),
         legend.box.background = element_rect(fill='transparent'))

socal_ac <- wpr %>%
  group_by(yr_mo, zone) %>%
  summarise(acou_blu = mean(blue_acoustic_percent, na.rm = TRUE)) %>%
  filter(zone == "Socal VSR") %>%
  ggplot(aes(x = as.Date(yr_mo))) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = as.Date(yr_mo_s), xmax = as.Date(yr_mo_e)), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(aes(y = acou_blu), size = 3, color = "#1F2D3D")+
  geom_path(aes(y = acou_blu), size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  scale_y_continuous(name = "Acoustics detection percentage (%)")+
  scale_x_date(date_breaks = "9 month",
                 date_labels = "%b %Y",
                 oob = scales::oob_keep,
                 limits = as.Date(c('2020-10-01','2025-01-01'), format = "%Y-%m-%d"))+
  ms_theme()+
  theme(
         panel.background = element_rect(fill='transparent', color = NA),
         plot.background = element_rect(fill='transparent', color=NA),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         legend.background = element_blank(),
         legend.box.background = element_rect(fill='transparent'))

socal_ww <- wpr %>%
  group_by(yr_mo, zone) %>%
  summarise(ww_blu = mean(bwmv, na.rm = TRUE)) %>%
  filter(zone == "Socal VSR") %>%
  ggplot(aes(x = as.Date(yr_mo))) +
  geom_rect(data = socal_vsr_on2, aes(ymin = -Inf, ymax = Inf, xmin = as.Date(yr_mo_s), xmax = as.Date(yr_mo_e)), inherit.aes = FALSE, fill = "grey", alpha = 0.5)+
  geom_point(aes(y = ww_blu), size = 3, color = "#1F2D3D")+
  geom_path(aes(y = ww_blu), size = 1.5, alpha = 0.8, color = "#1F2D3D")+
  xlab("")+
  ylab("Habitat suitability index") +
  scale_x_date(date_breaks = "9 month",
                 date_labels = "%b %Y",
                 oob = scales::oob_keep,
                 limits = as.Date(c('2020-10-01','2025-01-01'), format = "%Y-%m-%d"))+
  ms_theme()+
  theme(
         panel.background = element_rect(fill='transparent', color = NA),
         plot.background = element_rect(fill='transparent', color=NA),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         legend.background = element_blank(),
         legend.box.background = element_rect(fill='transparent'))

all_socal <- socal_sight/socal_ac/socal_ww
all_socal
# ggsave(here("figs/blue_ts/socal.png"), all_socal, height = 10, width = 9, units = c("in"),bg= 'transparent')
```

### Blue whale data stream time series x year

::: panel-tabset
#### Sightings

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 5
#| fig-align: "center"
#| label: blue whale data timeseries, sight

wpr_join <- wpr_join %>% 
  mutate(mo_nm = lubridate::month(mo, label = TRUE, abbr = TRUE))

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  #filter(s_bluecount > 0) %>%
  mutate(year = as.factor(year)) %>%
  group_by(mo_nm, year, zone) %>%
  summarise(mean_co = mean(s_bluecount, na.rm = TRUE)) %>%
  ggplot(aes(x = as.factor(mo_nm), y = mean_co, group = as.factor(year)))+
  geom_path(aes(color = year), size = 1, alpha = 0.4)+
  geom_point(aes(color = year), size = 4)+
  xlab("") +
  ylab("Blue whale sightings (No. whales)")+
  scale_color_manual(values = met.brewer("Hokusai2", n = 6)) +
  scale_fill_manual(values = met.brewer("Hokusai2", n = 6)) + 
  facet_wrap(~zone)+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

As an example, we could also plot the data as a ridge line plot. This is presenting data across years for just the Southern California VSR zone. This plot style is repeated below and only shows data for the SoCal zone.

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| label: blue whale data timeseries, sight ridge

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  filter(zone == "Socal VSR" & year != 2025) %>%
  ggplot(aes(x = s_bluecount, y = as.factor(mo_nm), fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "Blue whale sightings (No. whales)", option = "C") +
  facet_wrap(~year, scales = "free_x")+
  xlim(0, 6)+
  ms_theme()+
  theme(axis.title.y = element_blank())

```

#### Acoustics

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 5
#| fig-align: "center"
#| label: blue whale data timeseries, acou

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  mutate(year = as.factor(year)) %>%
  group_by(mo_nm, year, zone) %>%
  summarise(mean_co = mean(bw_ac_score, na.rm = TRUE)) %>%
  ggplot(aes(x = as.factor(mo_nm), y = mean_co, group = as.factor(year)))+
  geom_path(aes(color = year), size = 1, alpha = 0.4)+
  geom_point(aes(color = year), size = 4)+
  xlab("") +
  ylab("Blue whale acoustic rating")+
  scale_color_manual(values = met.brewer("Hokusai2", n = 6)) +
  scale_fill_manual(values = met.brewer("Hokusai2", n = 6)) + 
  facet_wrap(~zone)+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| label: blue whale data timeseries, acou ridge

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  filter(zone == "Socal VSR" & year != 2025) %>%
  ggplot(aes(x = bw_ac_score, y = as.factor(mo_nm), fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "Blue acoustic score", option = "C") +
  facet_wrap(~year, scales = "free_x")+
  xlim(0, 4)+
  ms_theme()+
  theme(axis.title.y = element_blank())

```

#### Whale Watch

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 5
#| fig-align: "center"
#| label: blue whale data timeseries, ww

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  mutate(year = as.factor(year)) %>%
  group_by(mo_nm, year, zone) %>%
  summarise(mean_co = mean(bwmv, na.rm = TRUE)) %>%
  ggplot(aes(x = as.factor(mo_nm), y = mean_co, group = as.factor(year)))+
  geom_path(aes(color = year), size = 1, alpha = 0.4)+
  geom_point(aes(color = year), size = 4)+
  xlab("") +
  ylab("Blue whale HSI score")+
  scale_color_manual(values = met.brewer("Hokusai2", n = 6)) +
  scale_fill_manual(values = met.brewer("Hokusai2", n = 6)) + 
  facet_wrap(~zone)+
  ms_theme()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
#| warning: false
#| echo: false
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| label: blue whale data timeseries, ww ridge 

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  filter(zone == "Socal VSR" & year != 2025) %>%
  ggplot(aes(x = bwmv, y = as.factor(mo_nm), fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "Blue whale HSI score", option = "C") +
  facet_wrap(~year, scales = "free_x")+
  xlim(0, 1)+
  ms_theme()+
  theme(axis.title.y = element_blank(), 
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12))

```
:::

## Correlation analysis for both zones: Confirmed whale occurrence and WhaleWatch predictions

::: panel-tabset
### Plot of relationships

```{r}
#| warning: false
#| echo: false
#| label: blue whale data stream comparison corr test, plot


#HSI scores need to be on x-axis for gam to run
wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  ggplot(aes(bwmv, bw_ac_score, color = zone)) + 
  geom_point()+ 
  geom_smooth(method = "gam")+
  scale_color_manual(values = c("#1F2D3D", "#4682B4"))+
  facet_wrap(~zone)+
  ylab("Acoustinc rating")+
  xlab("Whale Watch HSI score") + 
  labs(color = "") +
  ms_theme()+
  theme(legend.position = "none")

wpr_join %>% 
  distinct(id, .keep_all = TRUE) %>%
  ggplot(aes(bwmv, s_bluecount, color = zone)) + 
  geom_point()+ 
  geom_smooth(method = "gam")+
  scale_color_manual(values = c("#1F2D3D", "#4682B4"))+
  facet_wrap(~zone, scales = "free")+
  ylab("Sightings (No. whales)")+
  xlab("Whale Watch HSI score") + 
  labs(color = "") +
  ms_theme()+
  theme(legend.position = "none")

```

### Acoustics \~ WhaleWatch

**Pearson's**

```{r}
#| warning: false
#| label: blue whale data stream comparison corr test, pear acou

sf_corr <- wpr_join %>% filter(zone == "SF VSR")
socal_corr <- wpr_join %>% filter(zone == "Socal VSR")

#SF
cor.test(sf_corr$bwmv, sf_corr$bw_ac_score)

#Socal
cor.test(socal_corr$bwmv, socal_corr$bw_ac_score)


```

**Spearman's**

```{r}
#| warning: false
#| label: blue whale data stream comparison corr test, spear acou

#SF
cor.test(sf_corr$bwmv, sf_corr$bw_ac_score, method = "spearman")


#Socal
cor.test(socal_corr$bwmv, socal_corr$bw_ac_score, method = "spearman")

```

**Kendall's**

```{r}
#| warning: false
#| label: blue whale data stream comparison corr test, ken acou

#SF
cor.test(sf_corr$bwmv, sf_corr$bw_ac_score, method = "kendall")

#Socal
cor.test(socal_corr$bwmv, socal_corr$bw_ac_score, method = "kendall")

```

### Sightings \~ WhaleWatch

**Pearson's**

```{r}
#| warning: false
#| label: blue whale data stream comparison corr test, pear sight

#SF
cor.test(sf_corr$bwmv, sf_corr$s_bluecount)

#Socal
cor.test(socal_corr$bwmv, socal_corr$s_bluecount)

```

**Spearman's**

```{r}
#| warning: false
#| label: blue whale data stream comparison corr test, spear sight

#SF
cor.test(sf_corr$bwmv, sf_corr$s_bluecount, method = "spearman")


#Socal
cor.test(socal_corr$bwmv, socal_corr$s_bluecount, method = "spearman")

```

**Kendall's**

```{r}
#| warning: false
#| label: blue whale data stream comparison corr test, ken sight

#SF
cor.test(sf_corr$bwmv, sf_corr$s_bluecount, method = "kendall")

#Socal
cor.test(socal_corr$bwmv, socal_corr$s_bluecount, method = "kendall")

```

### Summary table

```{r}
#| warning: false
#| echo: false
#| label: blue whale data stream comparison corr test, table

cor_suite_test <- function(col1, col2, df){
  #split df by region
  sf_corr <- df %>% filter(zone == "SF VSR")
  socal_corr <- df %>% filter(zone == "Socal VSR")
  
  #create empty df to store results
  corr_results <- NULL
  corr_temp <- data.frame(matrix(ncol = 4, nrow = 1))
  colnames(corr_temp) <- c("Region", "Correlation", "Method", "Correlation metric")
  
  #run each correlation method: SF
  cor_methods <- c("pearson", "kendall", "spearman")
  for(i in 1:3){
    sf <- cor.test(sf_corr[[col1]], sf_corr[[col2]], method = cor_methods[i])

    corr_temp$Region <- "San Francisco"
    corr_temp$Correlation <- paste0(col1, "~", col2)
    corr_temp$Method <- cor_methods[i]
    corr_temp$`Correlation metric` <- sf$estimate
    
    corr_results <- rbind(corr_results, corr_temp)
  } #end for loop
  
  #run each correlation method: Socal
  for(i in 1:3){
    socal <- cor.test(socal_corr[[col1]], socal_corr[[col2]], method = cor_methods[i])
    
    corr_temp$Region <- "Southern California"
    corr_temp$Correlation <- paste0(col1, "~", col2)
    corr_temp$Method <- cor_methods[i]
    corr_temp$`Correlation metric` <- socal$estimate
    
    corr_results <- rbind(corr_results, corr_temp)
  } #end for loop
  
  return(corr_results)
  
} #end function

#run function for both correlations
acous_ww_corr <- cor_suite_test(col1 = "bw_ac_score", col2 = "bwmv", df = wpr_join)
sight_ww_corr <- cor_suite_test(col1 = "s_bluecount", col2 = "bwmv", df = wpr_join)

#print as tables
kbl(acous_ww_corr[,2:4], caption = "Acoustics & WhaleWatch Correlation") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows("San Francisco", 1,3, label_row_css = "background-color: #134f5c ; color: #fff;") %>%
  pack_rows("Southern California", 4, 6, label_row_css = "background-color: #134f5c ; color: #fff;") 

kbl(sight_ww_corr[,2:4], caption = "Sightings & WhaleWatch Correlation") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows("San Francisco", 1,3, label_row_css = "background-color: #134f5c ; color: #fff;") %>%
  pack_rows("Southern California", 4, 6, label_row_css = "background-color: #134f5c ; color: #fff;") 

```
:::
